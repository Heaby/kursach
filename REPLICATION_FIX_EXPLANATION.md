# Исправление проблемы репликации

## Проблема

После выполнения скрипта настройки репликации таблицы `Branches`, `Components` и другие не появились в базах филиалов (`Branch1_Merge_Comp` и `Branch2_Merge_Comp`).

## Причины проблемы

1. **Фильтр `SUSER_SNAME()` работает некорректно**: Функция `substring(SUSER_SNAME(), 11, 1)` пытается извлечь число из имени пользователя, но это может не работать, если имя пользователя не имеет нужного формата.

2. **Моментальные снимки не были созданы/применены**: Таблицы могут отсутствовать, если агент моментальных снимков не завершил работу успешно.

3. **SQL Server Agent не запущен**: Агенты репликации требуют запущенный SQL Server Agent.

## Решения

### Шаг 1: Диагностика

Выполните скрипт `check_replication_status.sql` для проверки:
- Статуса публикации
- Статуса подписок  
- Готовности моментальных снимков
- Журналов агентов

### Шаг 2: Исправление

Выполните скрипт `fix_replication.sql`, который:
- Проверит готовность моментальных снимков
- Запустит синхронизацию вручную
- Проверит наличие таблиц после синхронизации

### Шаг 3: Альтернативное решение

Если проблема сохраняется, используйте `alternative_solution.sql`, который пересоздает публикацию с правильными настройками фильтрации.

## Важные замечания

1. **SQL Server Agent должен быть запущен**: Проверьте в SQL Server Configuration Manager или Services.

2. **Проверьте права доступа**: Логины `merge_agent_1` и `merge_agent_2` должны иметь соответствующие права.

3. **Проверьте папку моментальных снимков**: Убедитесь, что агенты имеют доступ к папке для хранения снимков.

4. **Подождите достаточно времени**: Создание моментальных снимков может занять 5-10 минут для больших таблиц.

## Проверка в SSMS

Также можете проверить статус репликации в SQL Server Management Studio:
- Разверните узел **Replication** → **Local Publications**
- Найдите публикацию `MergePub_ComputerShop`
- Посмотрите на статус подписок и агентов




