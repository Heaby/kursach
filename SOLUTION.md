# Решение проблемы репликации

## Проблема

Таблицы не реплицируются в базы филиалов (`Branch1_Merge_Comp` и `Branch2_Merge_Comp`). Ошибка: "Недопустимое имя объекта".

## Причины

1. **Фильтр `SUSER_SNAME()` работает некорректно**: `substring(SUSER_SNAME(), 11, 1)` пытается извлечь число из имени пользователя, но может не работать из-за:
   - Длины имени пользователя
   - Формата имени пользователя
   - Обработки параметризованных фильтров в SQL Server

2. **Моментальные снимки не применяются**: Даже если снимки готовы, они могут не применяться к подписчикам из-за ошибок фильтрации.

3. **Агенты не запускаются**: SQL Server Agent может быть не запущен или задания созданы неправильно.

## Решения (по порядку применения)

### Решение 1: Диагностика (ПЕРВОЕ, ЧТО НУЖНО СДЕЛАТЬ)

Выполните скрипт `fix_filter_problem.sql` для проверки, правильно ли работает фильтр:

```sql
-- Этот скрипт покажет, какое значение извлекается из SUSER_SNAME()
```

**Если извлеченное значение НЕ равно 1 или 2** - фильтр работает неправильно!

### Решение 2: Исправление фильтра в существующей публикации

Если фильтр работает неправильно, попробуйте изменить позицию в substring:

1. Выполните `fix_filter_problem.sql` для определения правильной позиции
2. Если нужно изменить с позиции 11 на 12 (или другую), используйте:

```sql
-- Для merge_agent_1 должно быть BranchID = 1
-- Для merge_agent_2 должно быть BranchID = 2

-- Проверьте правильную позицию через:
SELECT SUBSTRING('merge_agent_1', 12, 1) -- должно быть '1'
SELECT SUBSTRING('merge_agent_2', 12, 1) -- должно быть '2'
```

3. Если позиция не 11 и не 12, вам нужно пересоздать публикацию (Решение 3).

### Решение 3: Пересоздание публикации с правильным фильтром

**ВНИМАНИЕ**: Это удалит существующую публикацию!

1. Выполните скрипт `recreate_publication_fixed.sql`
   - Он использует позицию 12 вместо 11
   - Если это не помогает, нужно использовать другое решение

2. Если и это не помогает, используйте явное указание значений фильтра через параметры подписки (см. Решение 4).

### Решение 4: Использование явных значений фильтра (РЕКОМЕНДУЕТСЯ)

Вместо извлечения из имени пользователя, можно использовать другой подход:

1. Удалите текущую публикацию
2. Создайте публикацию БЕЗ фильтров в статьях (только фильтры соединения)
3. При создании подписок используйте параметр `@subscription_type` с явным указанием значения фильтра

**Или** используйте таблицу-параметр для хранения соответствия между подписчиком и BranchID.

### Решение 5: Ручная синхронизация

Если снимки готовы, но таблицы не появляются:

1. Убедитесь, что SQL Server Agent запущен
2. Выполните `manual_sync.sql` для просмотра заданий
3. Запустите задания вручную через SSMS:
   - SQL Server Agent -> Jobs
   - Найдите задания для вашей публикации
   - Запустите их вручную

### Решение 6: Проверка через SSMS

1. Откройте SQL Server Management Studio
2. Разверните: Replication -> Local Publications -> MergePub_ComputerShop
3. Посмотрите на подписки:
   - Если есть ошибки - проверьте журналы
   - Если подписки активны - проверьте, применялись ли снимки
4. Проверьте SQL Server Agent -> Jobs для заданий агентов

## Пошаговая инструкция

1. **Сначала выполните диагностику**:
   ```sql
   -- Выполните fix_filter_problem.sql
   ```

2. **Если фильтр работает неправильно**:
   ```sql
   -- Выполните recreate_publication_fixed.sql (удалит и пересоздаст публикацию)
   ```

3. **Дождитесь создания снимков** (5-10 минут):
   ```sql
   -- Выполните check_replication_status.sql для проверки
   ```

4. **Если снимки готовы, но таблицы не появились**:
   ```sql
   -- Выполните manual_sync.sql и запустите задания вручную
   ```

5. **Проверьте результат**:
   ```sql
   USE Branch1_Merge_Comp;
   SELECT * FROM sys.tables WHERE name = 'Branches';
   ```

## Важные замечания

- SQL Server Agent **ДОЛЖЕН быть запущен**
- Создание моментальных снимков может занять **5-10 минут**
- Проверьте права доступа логинов `merge_agent_1` и `merge_agent_2`
- Проверьте папку для моментальных снимков (по умолчанию в папке репликации)

## Альтернативное решение

Если ничего не помогает, рассмотрите использование **транзакционной репликации с фильтрацией** вместо merge replication, или используйте другой механизм синхронизации данных.




